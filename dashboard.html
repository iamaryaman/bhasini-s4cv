<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S4CV - Smart Voice Resume Builder</title>
    
    <!-- Styles -->
    <link rel="stylesheet" href="dark-theme.css">
    <link rel="stylesheet" href="light-theme.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Additional specific styles */
        .realtime-transcription {
            background: var(--dark-bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            min-height: 150px;
            margin-top: var(--spacing-md);
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            position: relative;
        }
        
        .transcription-text {
            line-height: 1.8;
            font-size: 1rem;
        }
        
        .transcription-partial {
            color: var(--text-tertiary);
            font-style: italic;
        }
        
        .transcription-final {
            color: var(--text-primary);
        }
        
        .language-indicator {
            position: absolute;
            top: var(--spacing-md);
            right: var(--spacing-md);
            background: var(--gradient-accent);
            color: white;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .connection-status.connected {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-success);
        }
        
        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-error);
        }
        
        .connection-status.connecting {
            background: rgba(245, 158, 11, 0.1);
            color: var(--accent-warning);
        }
        
        .pulse-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }
        
        .waveform-visualizer {
            width: 100%;
            height: 80px;
            background: var(--dark-bg-tertiary);
            border-radius: var(--radius-md);
            margin: var(--spacing-md) 0;
        }
        
        canvas {
            width: 100%;
            height: 100%;
            border-radius: var(--radius-md);
            display: none !important;
        }
        
        .auto-detect-toggle {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin: var(--spacing-md) 0;
        }
        
        .toggle-switch {
            width: 48px;
            height: 24px;
            background: var(--dark-bg-tertiary);
            border-radius: var(--radius-full);
            position: relative;
            cursor: pointer;
            transition: all var(--transition-base);
        }
        
        .toggle-switch.active {
            background: var(--accent-primary);
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: all var(--transition-base);
        }
        
        .toggle-switch.active::after {
            left: 26px;
        }
        
        /* Single Section Mode Styles */
        .single-section-wrapper {
            padding: 2rem 1rem;
        }
        
        .language-grid-compact {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .language-grid-compact .language-card {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            min-width: 80px;
        }
        
        .language-indicator-compact {
            background: var(--accent-primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .record-btn-large {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            padding: 2rem 3rem;
            border-radius: 1rem;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
        }
        
        .record-btn-large:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(79, 70, 229, 0.4);
        }
        
        .record-btn-large.recording {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            animation: pulse-recording 2s infinite;
        }
        
        @keyframes pulse-recording {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
        }
        
        .waveform-visualizer-compact {
            height: 40px;
            background: var(--dark-bg-tertiary);
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            border: 1px solid var(--border-primary);
            display: none !important;
        }
        
        .transcription-display {
            min-height: 200px;
            background: var(--dark-bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
        }
        
        .action-controls {
            border-top: 1px solid var(--border-primary);
            padding-top: 2rem;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Main Dashboard Container -->
    <div class="dashboard-container">
        
        <!-- Dashboard Header -->
        <header class="dashboard-header fade-in">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">üé§</span>
                    <span>S4CV</span>
                </div>
                
                <nav class="nav-menu">
                    <div class="connection-status connecting" id="connectionStatus">
                        <span class="pulse-dot"></span>
                        <span>Connecting...</span>
                    </div>
                    
                    <button class="btn btn-ghost">
                        <span>üìä</span> Dashboard
                    </button>
                    
                    <button class="btn btn-ghost" id="settingsBtn" onclick="dashboard.showSettingsModal()">
                        <span>‚öôÔ∏è</span> Settings
                    </button>
                    
                    <button class="btn btn-primary" id="newResumeBtn">
                        <span>‚ûï</span> New Resume
                    </button>
                </nav>
            </div>
        </header>


        <!-- Main Content Area -->
        <div class="single-section-wrapper">
            <div class="card slide-up" style="max-width: 1000px; margin: 0 auto;">
                <div class="text-center mb-4">
                    <h1 class="text-primary mb-2" data-translate="singleVoiceInputCVBuilder">üé§ Single Voice Input CV Builder</h1>
                    <div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(99, 102, 241, 0.1)); border: 2px solid rgba(99, 102, 241, 0.4); border-radius: 12px; padding: 20px; max-width: 900px; margin: 0 auto 20px;">
                        <p class="text-primary mb-3" style="font-size: 1.1rem; font-weight: 600;" data-translate="oneRecordingSession">‚ö° ONE RECORDING SESSION - ALL CV INFORMATION</p>
                        <p class="text-secondary mb-3" data-translate="noMultipleInputs">No multiple inputs! Just press record and speak continuously about your entire professional background. The AI will extract and organize everything automatically.</p>
                        
                        <div style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 15px; margin: 15px 0;">
                            <p class="text-primary" style="font-size: 0.95rem; margin-bottom: 12px;" data-translate="speakAboutAll"><strong>üó£Ô∏è Speak about ALL of these in ONE go:</strong></p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 8px; font-size: 0.85rem; color: var(--text-secondary);">
                                <div style="display: flex; align-items: center; gap: 8px;"><span>üìù</span> <span data-translate="fullNameContact">Your full name & contact details</span></div>
                                <div style="display: flex; align-items: center; gap: 8px;"><span>üíº</span> <span data-translate="workExperience">All work experience & companies</span></div>
                                <div style="display: flex; align-items: center; gap: 8px;"><span>üéì</span> <span data-translate="educationHistory">Complete education history</span></div>
                                <div style="display: flex; align-items: center; gap: 8px;"><span>üîß</span> <span data-translate="technicalSkills">All technical & soft skills</span></div>
                                <div style="display: flex; align-items: center; gap: 8px;"><span>üåç</span> <span data-translate="languagesFluent">Languages you speak fluently</span></div>
                                <div style="display: flex; align-items: center; gap: 8px;"><span>üìç</span> <span data-translate="locationDetails">Location & other details</span></div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(16, 185, 129, 0.1); border-left: 4px solid #10b981; padding: 12px 15px; border-radius: 6px;">
                            <p style="font-size: 0.85rem; margin: 0; color: var(--text-secondary); font-style: italic;">
                                ü§ñ <strong data-translate="aiProcessing">AI Processing:</strong> <span data-translate="aiProcessingDesc">The system will automatically parse your speech and organize it into proper CV sections with appropriate headings.</span>
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Language Selection (Compact) -->
                <div class="mb-4" id="languageSection">
                    <div class="flex items-center justify-center mb-3">
                        <div class="auto-detect-toggle mr-4">
                            <div class="toggle-switch active" id="autoDetectToggle"></div>
                            <label data-translate="autoDetectLanguage">Auto-detect language</label>
                        </div>
                        <div class="language-indicator-compact" id="currentLangIndicator" data-translate="autoDetectEnabled">Auto-detect enabled</div>
                    </div>
                    
                    <div class="language-grid-compact" id="languageGrid" style="opacity: 0.5; pointer-events: none;">
                        <div class="language-card selected" data-lang="hi">
                            <span class="language-flag">üáÆüá≥</span>
                            <span class="language-name">Hindi</span>
                        </div>
                        <div class="language-card" data-lang="en">
                            <span class="language-flag">üá∫üá∏</span>
                            <span class="language-name">English</span>
                        </div>
                        <div class="language-card" data-lang="ta">
                            <span class="language-flag">üáÆüá≥</span>
                            <span class="language-name">Tamil</span>
                        </div>
                        <div class="language-card" data-lang="te">
                            <span class="language-flag">üáÆüá≥</span>
                            <span class="language-name">Telugu</span>
                        </div>
                        <div class="language-card" data-lang="kn">
                            <span class="language-flag">üáÆüá≥</span>
                            <span class="language-name">Kannada</span>
                        </div>
                        <div class="language-card" data-lang="ml">
                            <span class="language-flag">üáÆüá≥</span>
                            <span class="language-name">Malayalam</span>
                        </div>
                    </div>
                </div>
                
                <!-- Single Recording Section -->
                <div class="text-center mb-4">
                    <div style="background: rgba(99, 102, 241, 0.05); border: 2px dashed rgba(99, 102, 241, 0.3); border-radius: 16px; padding: 25px; margin: 20px 0;">
                        <p style="font-size: 0.9rem; color: var(--text-primary); margin-bottom: 15px; font-weight: 500;">
                            üîä <strong data-translate="singleSpeechInput">SINGLE SPEECH INPUT:</strong> <span data-translate="speakContinuously">Speak continuously about your entire professional background</span>
                        </p>
                        <button class="record-btn-large" id="recordBtn">
                            <span style="font-size: 3.5rem;">üé§</span>
                            <div style="font-size: 1.2rem; margin-top: 10px; font-weight: 700;" data-translate="startCompleteCVRecording">START COMPLETE CV RECORDING</div>
                            <div style="font-size: 0.85rem; opacity: 0.85; margin-top: 6px; line-height: 1.4;" data-translate="oneContinuousSession">One continuous session ‚Ä¢ All CV information ‚Ä¢ AI auto-extracts everything</div>
                        </button>
                        <p style="font-size: 0.8rem; color: var(--text-tertiary); margin-top: 15px; font-style: italic;" data-translate="noNeedToPause">
                            ‚ö†Ô∏è No need to pause or separate topics - just speak naturally about everything!
                        </p>
                    </div>
                </div>
                
                <!-- Waveform and Status -->
                <div class="recording-status mb-4" style="display: none;">
                    <div class="waveform-visualizer-compact" style="display: none;">
                        <canvas id="waveformCanvas" width="0" height="0" style="display: none !important;"></canvas>
                    </div>
                    <div class="recording-tips" id="recordingTips" style="display: none;">
                        <div class="text-secondary" style="font-size: 0.9rem; text-align: center; padding: 20px; background: rgba(239, 68, 68, 0.1); border-radius: 12px; border: 2px solid rgba(239, 68, 68, 0.2);">
                            üî¥ <strong>RECORDING SINGLE CV SESSION...</strong><br>
                            <div style="margin-top: 12px; font-size: 0.85rem; line-height: 1.5; color: var(--text-primary);">
                                üîä <strong>Speak continuously</strong> - don't pause between topics!<br>
                                üìù Include ALL: name, contact, experience, education, skills, languages<br>
                                ü§ñ <em>The AI is listening and will organize everything automatically into proper CV sections</em>
                            </div>
                            <div style="margin-top: 10px; padding: 8px 12px; background: rgba(255, 255, 255, 0.1); border-radius: 6px; font-size: 0.75rem;">
                                ‚ö° TIP: Treat this like introducing yourself comprehensively to someone
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Live Transcription Display -->
                <div class="transcription-display" id="transcriptionDisplay">
                    <div class="transcription-text" id="transcriptionText">
                        <span class="transcription-final" id="finalText"></span>
                        <span class="transcription-partial" id="partialText"></span>
                        <div class="placeholder-text" id="placeholderText" style="color: var(--text-tertiary); font-style: italic; opacity: 0.8; text-align: left; padding: 30px 25px; line-height: 1.6;">
                            <div style="text-align: center; font-size: 1.2rem; margin-bottom: 20px; color: var(--text-primary);">
                                üéôÔ∏è <strong data-translate="singleVoiceInputComplete">Single Voice Input - Complete CV Information</strong>
                            </div>
                            
                            <div style="background: rgba(255, 255, 255, 0.03); border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                                <p style="color: var(--accent-primary); font-size: 0.95rem; margin-bottom: 12px; font-weight: 600;" data-translate="exampleRecording">üó£Ô∏è Example of what to say in ONE recording:</p>
                                <div style="font-size: 0.87rem; line-height: 1.7; color: var(--text-secondary); font-style: normal;">
                                    <em>"My name is Raj Kumar and my email is raj.kumar@gmail.com. My phone number is +91 9876543210. I live in Bangalore, India. <br><br>
                                    
                                    I currently work as a Senior Software Engineer at TechCorp Solutions for the past 4 years. Before that, I was a Junior Developer at StartupXYZ for 2 years. I have experience in full-stack development and leading small teams. <br><br>
                                    
                                    I completed my Bachelor of Technology in Computer Science from VIT University in 2017. I also have a certification in AWS Cloud Computing. <br><br>
                                    
                                    My technical skills include JavaScript, Python, React, Node.js, MongoDB, and Docker. I also have experience with project management and agile methodologies. I'm fluent in English, Hindi, and Kannada. I have strong problem-solving and communication skills."</em>
                                </div>
                            </div>
                            
                            <div style="text-align: center; font-size: 0.8rem; color: var(--text-tertiary);" data-translate="aiWillExtract">
                                ü§ñ The AI will automatically extract and organize this into proper CV sections!
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Controls -->
                <div class="action-controls" id="actionControls" style="display: none;">
                    <div class="text-center mb-3">
                        <button class="btn btn-primary btn-lg" id="generateCVBtn">
                            <span>‚ú®</span> <span data-translate="generateMyCV">Generate My CV</span>
                        </button>
                    </div>
                    <div class="flex justify-center gap-3">
                        <button class="btn btn-secondary" id="clearBtn">
                            <span>üóëÔ∏è</span> <span data-translate="startOver">Start Over</span>
                        </button>
                        <button class="btn btn-secondary" id="copyBtn">
                            <span>üìã</span> <span data-translate="copyText">Copy Text</span>
                        </button>
                    </div>
                </div>
                
                <!-- Resume Preview -->
                <div class="resume-preview" id="resumePreview" style="display: none;">
                    <div style="border-top: 2px solid var(--accent-primary); padding-top: 2rem; margin-top: 2rem;">
                        <h2 class="text-primary mb-3 text-center" data-translate="resumePreview">üìÑ Resume Preview</h2>
                        <div class="preview-content" id="previewContent" style="background: var(--dark-bg-tertiary); border: 1px solid var(--border-primary); border-radius: var(--radius-md); padding: 2rem; max-height: 400px; overflow-y: auto;">
                            <!-- Preview content will be populated here -->
                        </div>
                        <div class="text-center mt-3">
                            <button class="btn btn-primary" onclick="dashboard.showExportModal(dashboard.currentResumeName || 'Generated Resume')">
                                <span>‚¨áÔ∏è</span> <span data-translate="exportThisResume">Export This Resume</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal" style="display: none; position: fixed; inset: 0; z-index: 9999; background: rgba(0, 0, 0, 0.5); align-items: center; justify-content: center;">
        <div class="modal-content" style="background: var(--dark-bg-secondary); border-radius: var(--radius-lg); padding: var(--spacing-xl); max-width: 400px; width: 90%; margin: auto; position: relative;">
            <button onclick="dashboard.hideExportModal()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer;">&times;</button>
            <h2 style="color: var(--text-primary); margin-bottom: var(--spacing-lg);" data-translate="exportResume">Export Resume</h2>
            <p style="color: var(--text-secondary); margin-bottom: var(--spacing-lg);" data-translate="chooseExportFormat">Choose your export format:</p>
            <div style="display: flex; gap: var(--spacing-md); flex-direction: column;">
                <button onclick="dashboard.exportResume('pdf')" class="btn btn-primary" style="width: 100%;">
                    <span>üìÑ</span> <span data-translate="exportAsPDF">Export as PDF</span>
                </button>
                <button onclick="dashboard.exportResume('word')" class="btn btn-secondary" style="width: 100%;">
                    <span>üìù</span> <span data-translate="exportAsWord">Export as Word Document</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal" style="display: none; position: fixed; inset: 0; z-index: 9999; background: rgba(0, 0, 0, 0.5); align-items: center; justify-content: center;">
        <div class="modal-content" style="background: var(--dark-bg-secondary); border-radius: var(--radius-lg); padding: var(--spacing-xl); max-width: 500px; width: 90%; margin: auto; position: relative; max-height: 80vh; overflow-y: auto;">
            <button onclick="dashboard.hideSettingsModal()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer;">&times;</button>
            <h2 style="color: var(--text-primary); margin-bottom: var(--spacing-lg);">Settings</h2>
            
            <!-- Appearance Settings -->
            <div style="margin-bottom: var(--spacing-xl);">
                <h3 style="color: var(--text-primary); margin-bottom: var(--spacing-md); font-size: 1.1rem;">Appearance</h3>
                <div style="margin-bottom: var(--spacing-md);">
                    <label style="display: flex; align-items: center; gap: var(--spacing-md); cursor: pointer;">
                        <span style="color: var(--text-secondary);">Theme Mode</span>
                        <div style="margin-left: auto; display: flex; gap: var(--spacing-sm);">
                            <button onclick="dashboard.setTheme('light')" id="lightThemeBtn" class="btn btn-ghost" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                <span>‚òÄÔ∏è</span> Light
                            </button>
                            <button onclick="dashboard.setTheme('dark')" id="darkThemeBtn" class="btn btn-ghost" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                <span>üåô</span> Dark
                            </button>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Language Settings -->
            <div style="margin-bottom: var(--spacing-xl);">
                <h3 style="color: var(--text-primary); margin-bottom: var(--spacing-md); font-size: 1.1rem;">Language</h3>
                <select id="appLanguageSelect" onchange="dashboard.changeAppLanguage(this.value)" class="form-control" style="width: 100%; padding: var(--spacing-sm); background: var(--dark-bg-tertiary); border: 1px solid var(--border-primary); border-radius: var(--radius-md); color: var(--text-primary);">
                    <option value="en">English</option>
                    <option value="hi">Hindi</option>
                    <option value="ta">Tamil</option>
                    <option value="te">Telugu</option>
                </select>
            </div>
            
            <!-- Voice Settings -->
            <div style="margin-bottom: var(--spacing-xl);">
                <h3 style="color: var(--text-primary); margin-bottom: var(--spacing-md); font-size: 1.1rem;">Voice Recognition</h3>
                <select id="voiceLanguageSelect" onchange="dashboard.changeVoiceLanguage(this.value)" class="form-control" style="width: 100%; padding: var(--spacing-sm); background: var(--dark-bg-tertiary); border: 1px solid var(--border-primary); border-radius: var(--radius-md); color: var(--text-primary);">
                    <option value="hi">Hindi</option>
                    <option value="en">English</option>
                    <option value="ta">Tamil</option>
                    <option value="te">Telugu</option>
                    <option value="kn">Kannada</option>
                    <option value="ml">Malayalam</option>
                    <option value="mr">Marathi</option>
                    <option value="gu">Gujarati</option>
                    <option value="bn">Bengali</option>
                    <option value="pa">Punjabi</option>
                    <option value="or">Odia</option>
                    <option value="as">Assamese</option>
                    <option value="ur">Urdu</option>
                </select>
            </div>
            
            <!-- About Section -->
            <div style="border-top: 1px solid var(--border-primary); padding-top: var(--spacing-lg);">
                <p style="color: var(--text-tertiary); font-size: 0.875rem; text-align: center;">S4CV Version 1.0.0</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="translations.js?v=2"></script>
    <script src="resume-export.js?v=2"></script>
    <script src="bhashini-service.js?v=2"></script>
    <script src="bhashini-websocket.js?v=2"></script>
    <script src="audio-utils.js?v=2"></script>
    <script src="multilingual-ner.js?v=2"></script>
    <script src="bhashini-ner-service.js?v=2"></script>
    <script src="ner-ui-components.js?v=2"></script>
    
    <script>
        // Enhanced Dashboard Controller with NER Integration
        class DashboardController {
            constructor() {
                this.nerService = new BhashiniNERService();
                this.currentLanguage = 'hi';
                this.autoDetectEnabled = true; // Default to auto-detect for single-section mode
                this.isRecording = false;
                this.finalText = '';
                this.visualizer = null;
                this.nerUI = null;
                this.extractedEntities = [];
                this.cvData = null;
                this.generatedCVData = null; // Store generated CV data for export
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.setupNERHandlers();
                this.initializeWaveform();
                this.updateConnectionStatus('connecting');
                
                // Clear any default text in transcription area
                document.getElementById('finalText').textContent = '';
                document.getElementById('partialText').textContent = '';
                
                // Hide action controls initially
                this.hideActionControls();
                
                // Initialize NER UI
                this.initializeNERUI();
                
                // Load translations if available
                setTimeout(() => {
                    if (typeof updatePageTranslations === 'function') {
                        updatePageTranslations();
                    }
                }, 100);
                
                // Load saved theme
                this.loadThemePreference();
            }
            
            setupEventListeners() {
                // Language cards
                document.querySelectorAll('.language-card').forEach(card => {
                    card.addEventListener('click', (e) => this.selectLanguage(e));
                });
                
                // Auto-detect toggle
                document.getElementById('autoDetectToggle').addEventListener('click', () => this.toggleAutoDetect());
                
                // Record button
                document.getElementById('recordBtn').addEventListener('click', () => this.toggleRecording());
                
                // Action buttons
                document.getElementById('clearBtn').addEventListener('click', () => this.clearTranscription());
                document.getElementById('copyBtn').addEventListener('click', () => this.copyTranscription());
                
                // New single-section mode event handlers
                const generateCVBtn = document.getElementById('generateCVBtn');
                if (generateCVBtn) {
                    generateCVBtn.addEventListener('click', () => this.generateCV());
                }
            }
            
            setupNERHandlers() {
                this.nerService.setHandlers({
                    onTranscriptionUpdate: (data) => this.handleTranscription(data),
                    onLanguageDetected: (data) => this.handleLanguageDetection(data),
                    onConnectionStatus: (status) => this.updateConnectionStatus(status),
                    onError: (error, details) => this.handleError(error, details),
                    onEntityExtracted: (data) => this.handleEntityExtraction(data),
                    onCVUpdated: (data) => this.handleCVUpdate(data),
                    onConfidenceUpdate: (metrics) => this.handleConfidenceUpdate(metrics)
                });
            }
            
            initializeNERUI() {
                // Create NER visualization UI when needed (lazy init)
                if (!this.nerUI && document.getElementById('nerVisualizationContainer')) {
                    this.nerUI = new NERVisualizationUI('nerVisualizationContainer', {
                        showConfidence: true,
                        enableEditing: true,
                        enableValidation: true
                    });
                    
                    // Setup callbacks for entity validation
                    this.nerUI.setCallbacks({
                        onEntityValidated: (entity, index) => {
                            console.log('Entity validated:', entity);
                        },
                        onEntityRejected: (entity, index) => {
                            console.log('Entity rejected:', entity);
                        },
                        onEntityEdited: (entity, index, changes) => {
                            console.log('Entity edited:', entity, changes);
                        },
                        onValidationComplete: (result) => {
                            console.log('Validation complete:', result);
                            this.generateCVFromValidatedEntities(result.validated);
                        }
                    });
                }
            }
            
            async selectLanguage(e) {
                if (this.autoDetectEnabled) return;
                
                const card = e.currentTarget;
                const lang = card.dataset.lang;
                
                // Update UI
                document.querySelectorAll('.language-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                
                // Update indicator
                const langName = card.querySelector('.language-name').textContent;
                document.getElementById('currentLangIndicator').textContent = langName;
                
                // Switch language in NER service
                this.currentLanguage = lang;
                if (this.isRecording) {
                    await this.nerService.switchLanguage(lang);
                }
                
                // Save language preference and update translations
                localStorage.setItem('appLanguage', lang);
                this.updateAllTranslations();
                
                const message = typeof t === 'function' ? t('languageSwitched') : 'Language switched to';
                this.showToast('info', `${message} ${langName}`);
            }
            
            toggleAutoDetect() {
                const toggle = document.getElementById('autoDetectToggle');
                this.autoDetectEnabled = !this.autoDetectEnabled;
                toggle.classList.toggle('active');
                
                const languageGrid = document.getElementById('languageGrid');
                if (this.autoDetectEnabled) {
                    languageGrid.style.opacity = '0.5';
                    languageGrid.style.pointerEvents = 'none';
                    this.showToast('info', 'Auto-detect enabled. Speak in any supported language.');
                } else {
                    languageGrid.style.opacity = '1';
                    languageGrid.style.pointerEvents = 'auto';
                    this.showToast('info', 'Auto-detect disabled. Please select a language.');
                }
            }
            
            async toggleRecording() {
                const btn = document.getElementById('recordBtn');
                const recordingTips = document.getElementById('recordingTips');
                
                if (this.isRecording) {
                    // Stop recording
                    this.nerService.stopStreaming();
                    this.isRecording = false;
                    btn.classList.remove('recording');
                    btn.innerHTML = `
                        <span style="font-size: 3.5rem;">üé§</span>
                        <div style="font-size: 1.2rem; margin-top: 10px; font-weight: 700;">START COMPLETE CV RECORDING</div>
                        <div style="font-size: 0.85rem; opacity: 0.85; margin-top: 6px; line-height: 1.4;">One continuous session ‚Ä¢ All CV information ‚Ä¢ AI auto-extracts everything</div>
                    `;
                    this.stopWaveform();
                    
                    // Hide recording tips
                    if (recordingTips) recordingTips.style.display = 'none';
                    
                    // Auto-extract entities when recording stops and we have text
                    if (this.finalText.trim()) {
                        setTimeout(() => this.generateCV(), 500);
                    }
                } else {
                    // Start recording
                    try {
                        await this.nerService.initializeWebSocket(this.currentLanguage);
                        await this.nerService.startStreaming();
                        this.isRecording = true;
                        btn.classList.add('recording');
                        btn.innerHTML = `
                            <span style="font-size: 3.5rem;">‚èπÔ∏è</span>
                            <div style="font-size: 1.2rem; margin-top: 10px; font-weight: 700;">COMPLETE CV SESSION</div>
                            <div style="font-size: 0.85rem; opacity: 0.85; margin-top: 6px; line-height: 1.4;">Stop recording & let AI extract all CV information</div>
                        `;
                        this.startWaveform();
                        
                        // Show recording tips
                        if (recordingTips) recordingTips.style.display = 'block';
                        
                    } catch (error) {
                        this.showToast('error', 'Failed to start recording. Please check microphone permissions.');
                    }
                }
            }
            
            handleTranscription(data) {
                const finalTextEl = document.getElementById('finalText');
                const partialTextEl = document.getElementById('partialText');
                const placeholderEl = document.getElementById('placeholderText');
                
                // Hide placeholder when we start getting transcriptions
                if (placeholderEl && (data.text || data.accumulatedText)) {
                    placeholderEl.style.display = 'none';
                }
                
                if (data.isFinal && data.accumulatedText) {
                    // Use accumulated text from the service to prevent duplication
                    this.finalText = data.accumulatedText;
                    finalTextEl.textContent = this.finalText;
                    partialTextEl.textContent = '';
                    
                    // Show action controls when we have text
                    this.showActionControls();
                } else if (!data.isFinal) {
                    // Show partial text
                    partialTextEl.textContent = data.text;
                }
            }
            
            async handleLanguageDetection(data) {
                if (!this.autoDetectEnabled) return;
                
                // Update selected language
                document.querySelectorAll('.language-card').forEach(card => {
                    if (card.dataset.lang === data.language) {
                        card.classList.add('selected');
                    } else {
                        card.classList.remove('selected');
                    }
                });
                
                // Update indicator
                document.getElementById('currentLangIndicator').textContent = data.name;
                
                // Switch to detected language
                if (this.currentLanguage !== data.language) {
                    this.currentLanguage = data.language;
                    await this.wsService.switchLanguage(data.language);
                    this.showToast('success', `Language detected: ${data.name} (${Math.round(data.confidence * 100)}% confidence)`);
                }
            }
            
            updateConnectionStatus(status) {
                const statusEl = document.getElementById('connectionStatus');
                statusEl.className = 'connection-status';
                
                switch (status) {
                    case 'connected':
                        statusEl.classList.add('connected');
                        statusEl.innerHTML = '<span class="pulse-dot"></span><span>Connected</span>';
                        break;
                    case 'disconnected':
                        statusEl.classList.add('disconnected');
                        statusEl.innerHTML = '<span class="pulse-dot"></span><span>Disconnected</span>';
                        break;
                    default:
                        statusEl.classList.add('connecting');
                        statusEl.innerHTML = '<span class="pulse-dot"></span><span>Connecting...</span>';
                }
            }
            
            clearTranscription() {
                this.finalText = '';
                document.getElementById('finalText').textContent = '';
                document.getElementById('partialText').textContent = '';
                
                // Show placeholder again
                const placeholderEl = document.getElementById('placeholderText');
                if (placeholderEl) placeholderEl.style.display = 'block';
                
                // Hide action controls and resume preview
                this.hideActionControls();
                const previewEl = document.getElementById('resumePreview');
                if (previewEl) previewEl.style.display = 'none';
                
                // Clear NER data and UI
                this.extractedEntities = [];
                this.cvData = null;
                this.generatedCVData = null;
                if (this.nerUI) {
                    this.nerUI.clear();
                }
                this.hideNERVisualization();
                
                // Clear service data
                if (this.nerService) {
                    this.nerService.clearData();
                }
                
                this.showToast('info', 'Starting fresh - ready for new CV recording!');
            }
            
            copyTranscription() {
                const text = this.finalText;
                if (!text) {
                    this.showToast('warning', 'No text to copy');
                    return;
                }
                
                navigator.clipboard.writeText(text).then(() => {
                    this.showToast('success', 'Text copied to clipboard');
                });
            }
            
            nextStep() {
                if (!this.finalText) {
                    this.showToast('warning', 'Please record some content first');
                    return;
                }
                
                // Navigate to next step in resume creation
                this.showToast('info', 'Proceeding to next step...');
            }
            
            initializeWaveform() {
                const canvas = document.getElementById('waveformCanvas');
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                
                // Set initial style
                ctx.fillStyle = '#1e2139';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            startWaveform() {
                if (this.nerService.mediaStream) {
                    const canvas = document.getElementById('waveformCanvas');
                    this.visualizer = AudioUtils.visualizeAudio(this.nerService.mediaStream, canvas);
                }
            }
            
            stopWaveform() {
                if (this.visualizer) {
                    this.visualizer();
                    this.visualizer = null;
                    this.initializeWaveform();
                }
            }
            
            handleError(error, details) {
                console.error('Dashboard error:', error, details);
                this.showToast('error', error);
            }
            
            // NER-specific event handlers
            handleEntityExtraction(data) {
                this.extractedEntities = data.entities;
                console.log(`Extracted ${data.entities.length} entities for ${data.language}`);
                
                // Show NER UI if entities found
                if (data.entities.length > 0) {
                    this.showNERVisualization();
                }
                
                this.showToast('success', `Found ${data.entities.length} entities in ${data.language} text`);
            }
            
            handleCVUpdate(cvData) {
                this.cvData = cvData;
                console.log('CV data updated:', cvData);
            }
            
            handleConfidenceUpdate(metrics) {
                console.log('Confidence metrics:', metrics);
                // Could update UI with confidence indicators
            }
            
            async extractEntities() {
                const text = this.finalText;
                
                if (!text || text.trim().length === 0) {
                    this.showToast('warning', 'No text available for entity extraction');
                    return;
                }
                
                try {
                    // Initialize NER UI if not already done
                    this.initializeNERUI();
                    
                    const result = await this.nerService.extractEntitiesManual(text, this.currentLanguage);
                    
                    if (result.entities.length > 0) {
                        this.extractedEntities = result.entities;
                        this.cvData = result.cvData;
                        
                        // Display entities in UI
                        this.nerUI.displayEntities(result.entities, text);
                        this.showNERVisualization();
                        
                        this.showToast('success', `Extracted ${result.entities.length} entities with ${Math.round(result.confidence * 100)}% avg confidence`);
                    } else {
                        this.showToast('info', 'No entities found in the text');
                    }
                } catch (error) {
                    console.error('Entity extraction failed:', error);
                    this.showToast('error', 'Failed to extract entities from text');
                }
            }
            
            showNERVisualization() {
                const container = document.getElementById('nerVisualizationContainer');
                if (container) {
                    container.style.display = 'block';
                    // Scroll to NER visualization
                    container.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
            
            hideNERVisualization() {
                const container = document.getElementById('nerVisualizationContainer');
                if (container) {
                    container.style.display = 'none';
                }
            }
            
            generateCVFromValidatedEntities(validatedEntities) {
                if (!validatedEntities || validatedEntities.length === 0) {
                    this.showToast('warning', 'No validated entities to generate CV');
                    return;
                }
                
                try {
                    // Use the CV mapper to create structured CV data
                    const cvMapper = new CVFieldMapper();
                    const structuredCV = cvMapper.createCVStructure(validatedEntities, this.finalText);
                    
                    console.log('Generated CV data:', structuredCV);
                    
                    // You can now use this structured data for CV generation
                    this.showToast('success', `CV generated with ${validatedEntities.length} validated entities`);
                    
                    // Here you could integrate with your existing CV generation/export functionality
                    // this.exportGeneratedCV(structuredCV);
                    
                } catch (error) {
                    console.error('CV generation failed:', error);
                    this.showToast('error', 'Failed to generate CV from entities');
                }
            }
            
            showExportModal(resumeName) {
                this.currentResumeName = resumeName;
                const modal = document.getElementById('exportModal');
                if (modal) {
                    modal.style.display = 'flex';
                }
            }
            
            hideExportModal() {
                const modal = document.getElementById('exportModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
            
            showSettingsModal() {
                const modal = document.getElementById('settingsModal');
                if (modal) {
                    modal.style.display = 'flex';
                    
                    // Update current selections
                    const currentLang = localStorage.getItem('appLanguage') || 'en';
                    document.getElementById('appLanguageSelect').value = currentLang;
                    document.getElementById('voiceLanguageSelect').value = this.currentLanguage;
                    
                    // Update theme button states
                    this.updateThemeButtons();
                }
            }
            
            hideSettingsModal() {
                const modal = document.getElementById('settingsModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
            
            setTheme(theme) {
                const root = document.documentElement;
                const body = document.body;
                
                root.setAttribute('data-theme', theme);
                body.setAttribute('data-theme', theme);
                
                // Save preference
                localStorage.setItem('theme', theme);
                
                // Update button states
                this.updateThemeButtons();
                
                this.showToast('success', `Theme changed to ${theme} mode`);
            }
            
            updateThemeButtons() {
                const currentTheme = localStorage.getItem('theme') || 'dark';
                const lightBtn = document.getElementById('lightThemeBtn');
                const darkBtn = document.getElementById('darkThemeBtn');
                
                if (lightBtn && darkBtn) {
                    if (currentTheme === 'light') {
                        lightBtn.classList.add('btn-primary');
                        lightBtn.classList.remove('btn-ghost');
                        darkBtn.classList.add('btn-ghost');
                        darkBtn.classList.remove('btn-primary');
                    } else {
                        darkBtn.classList.add('btn-primary');
                        darkBtn.classList.remove('btn-ghost');
                        lightBtn.classList.add('btn-ghost');
                        lightBtn.classList.remove('btn-primary');
                    }
                }
            }
            
            loadThemePreference() {
                const savedTheme = localStorage.getItem('theme') || 'dark';
                this.setTheme(savedTheme);
            }
            
            changeAppLanguage(lang) {
                localStorage.setItem('appLanguage', lang);
                this.updateAllTranslations();
                this.showToast('success', `App language changed`);
            }
            
            changeVoiceLanguage(lang) {
                this.currentLanguage = lang;
                
                // Update language cards to match
                document.querySelectorAll('.language-card').forEach(card => {
                    if (card.dataset.lang === lang) {
                        card.classList.add('selected');
                    } else {
                        card.classList.remove('selected');
                    }
                });
                
                // Update indicator
                const langCard = document.querySelector(`[data-lang="${lang}"]`);
                if (langCard) {
                    const langName = langCard.querySelector('.language-name').textContent;
                    document.getElementById('currentLangIndicator').textContent = langName;
                }
                
                this.showToast('success', `Voice recognition language changed`);
            }
            
            async exportResume(format) {
                try {
                    // Use generated CV data if available, otherwise fall back to sample data
                    const resumeData = this.generatedCVData || {
                        personalInfo: {
                            fullName: this.currentResumeName || 'John Doe',
                            email: 'john.doe@example.com',
                            phone: '+91 98765 43210',
                            location: 'Mumbai, India'
                        },
                        contact: {
                            name: this.currentResumeName || 'John Doe',
                            email: 'john.doe@example.com',
                            phone: '+91 98765 43210',
                            location: 'Mumbai, India'
                        },
                        workExperience: [
                            {
                                jobTitle: 'Senior Software Engineer',
                                company: 'Tech Corp',
                                duration: '2020 - Present',
                                description: 'Led development of enterprise applications using modern web technologies. ' +
                                           'Managed a team of 5 developers and improved system performance by 40%.'
                            },
                            {
                                jobTitle: 'Software Developer',
                                company: 'StartUp Inc',
                                duration: '2018 - 2020',
                                description: 'Developed and maintained web applications using React and Node.js. ' +
                                           'Implemented CI/CD pipelines and automated testing procedures.'
                            }
                        ],
                        professionalSummary: 'Experienced professional with expertise in software development and project management. ' +
                                'Skilled in multiple programming languages and frameworks with a proven track record of delivering quality solutions.',
                        education: [
                            {
                                degree: 'B.Tech in Computer Science',
                                institution: 'IIT Mumbai',
                                year: '2014 - 2018',
                                details: 'Graduated with honors. Focus on AI and Machine Learning.'
                            }
                        ],
                        skills: {
                            technical: ['JavaScript', 'React', 'Node.js', 'Python', 'MongoDB', 'AWS'],
                            soft: ['Leadership', 'Communication', 'Problem Solving', 'Team Work'],
                            languages: ['English', 'Hindi', 'Marathi']
                        }
                    };
                    
                    // Generate filename with timestamp
                    const timestamp = new Date().toISOString().slice(0, 10);
                    const filename = `${this.currentResumeName.replace(/\s+/g, '_')}_${timestamp}.${format === 'pdf' ? 'pdf' : 'docx'}`;
                    
                    // Make sure the export module is loaded
                    if (!window.resumeExporter) {
                        this.showToast('error', 'Export module not loaded. Please refresh the page.');
                        return;
                    }
                    
                    // Export based on format
                    if (format === 'pdf') {
                        await window.resumeExporter.exportToPDF(resumeData, filename);
                        this.showToast('success', 'Resume exported as PDF successfully!');
                    } else if (format === 'word') {
                        await window.resumeExporter.exportToWord(resumeData, filename);
                        this.showToast('success', 'Resume exported as Word document successfully!');
                    }
                    
                    this.hideExportModal();
                    
                } catch (error) {
                    console.error('Export failed:', error);
                    this.showToast('error', `Failed to export resume: ${error.message}`);
                }
            }
            
            showActionControls() {
                const controls = document.getElementById('actionControls');
                if (controls) {
                    controls.style.display = 'block';
                }
            }
            
            hideActionControls() {
                const controls = document.getElementById('actionControls');
                if (controls) {
                    controls.style.display = 'none';
                }
            }
            
            showResumePreview(cvData) {
                const previewSection = document.getElementById('resumePreview');
                const previewContent = document.getElementById('previewContent');
                
                if (!previewSection || !previewContent) return;
                
                // Generate preview HTML
                let previewHTML = '';
                
                // Title
                previewHTML += '<div style="text-align: center; margin-bottom: 20px; font-family: Arial, sans-serif;">';
                previewHTML += '<h1 style="font-size: 20px; font-weight: bold; margin-bottom: 5px; color: #2c3e50;">CURRICULUM VITAE</h1>';
                previewHTML += '</div>';
                
                // Name (separate from contact info)
                const fullName = cvData.personalInfo?.fullName || cvData.contact?.name;
                if (fullName) {
                    previewHTML += `<h2 style="color: #34495e; margin-bottom: 15px;">${this.escapeHtml(fullName)}</h2>`;
                }
                
                // Contact Information
                const contactInfo = cvData.personalInfo || cvData.contact;
                if (contactInfo) {
                    previewHTML += `<h3 style="color: #2c3e50; margin: 15px 0 10px 0; font-size: 16px; border-bottom: 1px solid #3498db; padding-bottom: 5px;">${t('contactInformation')}</h3>`;
                    if (contactInfo.email) previewHTML += `<p style="margin: 5px 0; font-size: 14px;"><strong>${t('email')}:</strong> ${this.escapeHtml(contactInfo.email)}</p>`;
                    if (contactInfo.phone) previewHTML += `<p style="margin: 5px 0; font-size: 14px;"><strong>${t('phone')}:</strong> ${this.escapeHtml(contactInfo.phone)}</p>`;
                    if (contactInfo.location) previewHTML += `<p style="margin: 5px 0; font-size: 14px;"><strong>${t('location')}:</strong> ${this.escapeHtml(contactInfo.location)}</p>`;
                }
                
                // Professional Summary
                const summary = cvData.professionalSummary || cvData.summary;
                if (summary) {
                    previewHTML += `<h3 style="color: #2c3e50; margin: 20px 0 10px 0; font-size: 16px; border-bottom: 1px solid #3498db; padding-bottom: 5px;">${t('professionalSummary')}</h3>`;
                    previewHTML += `<p style="margin: 10px 0; font-size: 14px; line-height: 1.6;">${this.escapeHtml(summary)}</p>`;
                }
                
                // Work Experience (try both workExperience and experience)
                const workExp = cvData.workExperience || cvData.experience;
                if (workExp && workExp.length > 0) {
                    previewHTML += `<h3 style="color: #2c3e50; margin: 20px 0 10px 0; font-size: 16px; border-bottom: 1px solid #3498db; padding-bottom: 5px;">${t('workExperienceSection')}</h3>`;
                    workExp.forEach(exp => {
                        previewHTML += '<div style="margin: 15px 0; padding-left: 20px;">';
                        const title = exp.jobTitle || exp.title || exp.position || '';
                        previewHTML += `<h4 style="color: #555; margin: 5px 0; font-size: 15px;">${this.escapeHtml(title)} at ${this.escapeHtml(exp.company || '')}</h4>`;
                        if (exp.duration) previewHTML += `<p style="font-style: italic; color: #666; margin: 3px 0; font-size: 13px;">${this.escapeHtml(exp.duration)}</p>`;
                        if (exp.description) previewHTML += `<p style="margin: 8px 0; font-size: 14px; line-height: 1.5;">${this.escapeHtml(exp.description)}</p>`;
                        previewHTML += '</div>';
                    });
                }
                
                // Education
                if (cvData.education && cvData.education.length > 0) {
                    previewHTML += `<h3 style="color: #2c3e50; margin: 20px 0 10px 0; font-size: 16px; border-bottom: 1px solid #3498db; padding-bottom: 5px;">${t('educationSection')}</h3>`;
                    cvData.education.forEach(edu => {
                        previewHTML += '<div style="margin: 15px 0; padding-left: 20px;">';
                        previewHTML += `<h4 style="color: #555; margin: 5px 0; font-size: 15px;">${this.escapeHtml(edu.degree || '')} - ${this.escapeHtml(edu.institution || '')}</h4>`;
                        if (edu.year) previewHTML += `<p style="font-style: italic; color: #666; margin: 3px 0; font-size: 13px;">${this.escapeHtml(edu.year)}</p>`;
                        if (edu.details) previewHTML += `<p style="margin: 8px 0; font-size: 14px; line-height: 1.5;">${this.escapeHtml(edu.details)}</p>`;
                        previewHTML += '</div>';
                    });
                }
                
                // Skills
                if (cvData.skills) {
                    previewHTML += `<h3 style="color: #2c3e50; margin: 20px 0 10px 0; font-size: 16px; border-bottom: 1px solid #3498db; padding-bottom: 5px;">${t('skillsSection')}</h3>`;
                    if (cvData.skills.technical && cvData.skills.technical.length > 0) {
                        previewHTML += `<p style="margin: 8px 0; font-size: 14px;"><strong>${t('technicalSkillsLabel')}:</strong> ${cvData.skills.technical.map(s => this.escapeHtml(s)).join(', ')}</p>`;
                    }
                    if (cvData.skills.soft && cvData.skills.soft.length > 0) {
                        previewHTML += `<p style="margin: 8px 0; font-size: 14px;"><strong>${t('softSkillsLabel')}:</strong> ${cvData.skills.soft.map(s => this.escapeHtml(s)).join(', ')}</p>`;
                    }
                    if (cvData.skills.languages && cvData.skills.languages.length > 0) {
                        previewHTML += `<p style="margin: 8px 0; font-size: 14px;"><strong>${t('languagesLabel')}:</strong> ${cvData.skills.languages.map(s => this.escapeHtml(s)).join(', ')}</p>`;
                    }
                }
                
                previewContent.innerHTML = previewHTML;
                previewSection.style.display = 'block';
                
                // Scroll to preview
                setTimeout(() => {
                    previewSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 300);
            }
            
            escapeHtml(text) {
                if (!text) return '';
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            }
            
            async generateCV() {
                if (!this.finalText || this.finalText.trim().length === 0) {
                    this.showToast('warning', 'No speech text available. Please record your complete CV information first.');
                    return;
                }
                
                try {
                    this.showToast('info', 'ü§ñ AI processing your comprehensive CV input - extracting all information...');
                    
                    // Use NER service to extract entities
                    const result = await this.nerService.extractEntitiesManual(this.finalText, this.currentLanguage);
                    
                    if (result.entities.length > 0) {
                        this.extractedEntities = result.entities;
                        this.cvData = result.cvData;
                        
                        // Create structured CV data
                        const cvMapper = new CVFieldMapper();
                        const structuredCV = cvMapper.createCVStructure(result.entities, this.finalText);
                        
                        console.log('Generated CV data from single input:', structuredCV);
                        
                        // Store generated data
                        this.currentResumeName = structuredCV.personalInfo?.fullName || structuredCV.contact?.name || 'Voice Generated Resume';
                        this.generatedCVData = structuredCV;
                        
                        // Show detailed extraction results
                        const extractionSummary = this.generateExtractionSummary(structuredCV);
                        
                        // Show preview
                        this.showResumePreview(structuredCV);
                        
                        this.showToast('success', `‚úÖ CV generated from single session! ${extractionSummary}`);
                    } else {
                        this.showToast('warning', '‚ö†Ô∏è Could not extract enough CV information from your recording. Please try recording again with more details about your name, contact info, experience, education, and skills.');
                    }
                } catch (error) {
                    console.error('CV generation from single input failed:', error);
                    this.showToast('error', '‚ùå Failed to process your comprehensive CV input. Please try recording again.');
                }
            }
            
            generateExtractionSummary(cvData) {
                const extracted = [];
                const contactInfo = cvData.personalInfo || cvData.contact;
                if (contactInfo?.fullName || contactInfo?.name) extracted.push('Name');
                if (contactInfo?.email) extracted.push('Email');
                if (contactInfo?.phone) extracted.push('Phone');
                const workExp = cvData.workExperience || cvData.experience;
                if (workExp?.length > 0) extracted.push(`${workExp.length} job(s)`);
                if (cvData.education?.length > 0) extracted.push(`${cvData.education.length} education`);
                if (cvData.skills?.technical?.length > 0) extracted.push(`${cvData.skills.technical.length} skills`);
                
                return `Extracted: ${extracted.join(', ')}`;
            }
            
            showToast(type, message) {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type} fade-in`;
                
                const icons = {
                    success: '‚úÖ',
                    error: '‚ùå',
                    warning: '‚ö†Ô∏è',
                    info: '‚ÑπÔ∏è'
                };
                
                toast.innerHTML = `
                    <div class="toast-icon">${icons[type] || '‚ÑπÔ∏è'}</div>
                    <div class="toast-content">
                        <div class="toast-message">${message}</div>
                    </div>
                `;
                
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 5000);
            }
            
            // Update all translations and force refresh of dynamic content
            updateAllTranslations() {
                if (typeof updatePageTranslations === 'function') {
                    updatePageTranslations();
                }
                
                // Force refresh of any generated content
                if (this.generatedCVData) {
                    this.showResumePreview(this.generatedCVData);
                }
                
                // Update auto-detect indicator
                const currentLangIndicator = document.getElementById('currentLangIndicator');
                if (currentLangIndicator && this.autoDetectEnabled) {
                    currentLangIndicator.textContent = t('autoDetectEnabled');
                }
            }
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboard = new DashboardController();
            
            // Force immediate translation update
            setTimeout(() => {
                if (typeof updatePageTranslations === 'function') {
                    updatePageTranslations();
                }
            }, 200);
        });
    </script>
</body>
</html>
